services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cosmeles-backend
    restart: unless-stopped
    env_file:
      - ./backend/.env.local
    environment:
      APP_ENV: prod
      STORAGE_DIR: /app/storage
      DATABASE_URL: sqlite:////app/storage/app.db
      DOUBAO_MODE: real
      DOUBAO_PRO_MODEL: doubao-seed-2-0-pro-260215
      DOUBAO_TIMEOUT_SECONDS: "180"
      DOUBAO_MAX_RETRIES: "2"
      DOUBAO_RETRY_BACKOFF_SECONDS: "1.5"
      AI_MODEL_PRICING_PER_MTOKEN_JSON: '{"doubao-seed-2-0-pro-260215":{"input":3.2,"output":16,"cache_hit":0.64},"doubao-seed-2-0-lite-260215":{"input":0.6,"output":3.6,"cache_hit":0.12},"doubao-seed-2-0-mini-260215":{"input":0.2,"output":2.0,"cache_hit":0.04}}'
    volumes:
      - ./backend/storage:/app/storage
    ports:
      - "127.0.0.1:8000:8000"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        BACKEND_HOST: backend
        BACKEND_PORT: "8000"
    container_name: cosmeles-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      BACKEND_HOST: backend
      BACKEND_PORT: "8000"
      INTERNAL_API_BASE: http://backend:8000
    ports:
      - "5001:3000"
    depends_on:
      - backend
